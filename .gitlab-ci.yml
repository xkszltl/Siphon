stages:
  - build

gcc-7:
  stage: build
  retry: 1
  tags:
    - docker
    - gpu
  script:
    - mkdir -p build
    - cd build
    - . /opt/intel/compilers_and_libraries/$(uname -s | tr '[A-Z]' '[a-z]')/bin/compilervars.sh intel64
    - set +e && . scl_source enable devtoolset-7 && set -e
    - cmake
          -DCMAKE_C_COMPILER=gcc
          -DCMAKE_C_FLAGS="-g"
          -DCMAKE_CXX_COMPILER=g++
          -DCMAKE_CXX_FLAGS="-g"
          -DCMAKE_MODULE_PATH="/usr/local/src/pytorch/cmake/Modules"
          -DCMAKE_VERBOSE_MAKEFILE=ON
          -DPYBIND11_PYTHON_VERSION=2.7
          -GNinja
          ..
    - cmake --build .
    - export PYTHONPATH="$(ls -d /usr/local/lib/python*/site-packages | paste -sd':' -):$PYTHONPATH"
    - mkdir -p squeezenet
    - pushd squeezenet
    - wget -c "https://git.codingcafe.org/Mirrors/caffe2/models/raw/master/$(basename "$(pwd)")/init_net.pb?inline=false" -O init_net.pb
    - wget -c "https://git.codingcafe.org/Mirrors/caffe2/models/raw/master/$(basename "$(pwd)")/predict_net.pb?inline=false" -O predict_net.pb
    - wget -c "https://git.codingcafe.org/Mirrors/caffe2/models/raw/master/$(basename "$(pwd)")/value_info.json?inline=false" -O value_info.json
    - popd
    - bin/siphon --caffe2_log_level 0 --load squeezenet --save c2net --save onnx model.onnx || true

